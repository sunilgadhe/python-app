pipeline {
  agent any
  environment {
    DOCKERTAG = "v1.0.${BUILD_NUMBER}" // Or however you define it
  }
  stages {
    stage('Clone repository') {
      steps {
        checkout scm
      }
    }

    stage('Update deployment.yaml') {
      steps {
        script {
          withCredentials([usernamePassword(credentialsId: 'github', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
            sh '''
              git config user.email "sunilgade.cloud@gmail.com"
              git config user.name "sunilgadhe"
              
              echo "=== BEFORE ==="
              cat deployment.yaml
              
              # Replace exact image line (adjust regex as needed)
              sed -i "s|image: sunilgadhe/test:.*|image: sunilgadhe/test:${DOCKERTAG}|g" deployment.yaml
              
              echo "=== AFTER ==="
              cat deployment.yaml
              
              git add deployment.yaml
              git diff --cached

              git commit -m "Updated image tag to ${DOCKERTAG} in deployment.yaml" || echo "No changes to commit"
              
              git push https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/${GIT_USERNAME}/kubernetesmanifest.git HEAD:main
            '''
          }
        }
      }
    }
  }
}
